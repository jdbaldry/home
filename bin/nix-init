#!/usr/bin/env bash

set -euf -o pipefail

readonly NIX_DIR="${NIX_DIR:-/home/jdb/nix}"
OWNER="$(basename "$(dirname "$(pwd)")")"
readonly OWNER
REPO="$(basename "$(pwd)")"
readonly REPO

# Idempotent 'git init'.
function git_init() {
  if [[ ! -d ".yadm" ]]; then
    if [[ ! -d ".git" ]]; then
      git init
    fi
  fi
}

function nix_init() {
  mkdir -p "${NIX_DIR}"/"${OWNER}"/"${REPO}"
  pushd "${NIX_DIR}"/"${OWNER}"/"${REPO}"

  git_init

  cat <<EOF >flake.nix
{
  description = "${REPO} shell development tooling";

  inputs.nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
  inputs.flake-utils.url = "github:numtide/flake-utils";

  outputs = { self, nixpkgs, flake-utils }:
    (flake-utils.lib.eachDefaultSystem (system:
      let pkgs = import nixpkgs { inherit system; };
      in { devShell = import ./shell.nix { inherit pkgs; }; }));
}
EOF

  cat <<EOF >shell.nix
{ pkgs ? import <nixpkgs> }:

with pkgs;
mkShell {
  buildInputs = [ hello ];
  shellHook = ''
    # ...
  '';
}
EOF

  git add shell.nix flake.nix
  git ci -sS -m "local: Add initial flakes support"

  popd

  cat <<EOF >.envrc
NIX_DIR=${NIX_DIR}/${OWNER}/${REPO}
use_flake() {
  watch_file \${NIX_DIR}/shell.nix
  watch_file \${NIX_DIR}/flake.nix
  watch_file \${NIX_DIR}/flake.lock
  eval "\$(cd \${NIX_DIR} && nix print-dev-env --profile flake-profile)"
}

use_flake
EOF

}

nix_init
direnv allow
direnv reload
mkdir -p .git/info
echo ".envrc" >>.git/info/exclude
